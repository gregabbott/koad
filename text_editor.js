//By + Copyright Greg Abbott 2023-2025 v 2025_0310
function setup_text_editor(e,t,n){const l=[],s=[];let a=0;const o=()=>{t&&t.classList[0==l.length?"add":"remove"]("disabled"),n&&n.classList[0==s.length?"add":"remove"]("disabled")},i=(t=e)=>{let n=l.length?l[l.length-1]:null;(!n||t.value!==n.value)&&(l.push({value:t.value,selectionStart:t.selectionStart,selectionEnd:t.selectionEnd,timestamp:Date.now()}),s.length=0,a=Date.now(),c(),o())},r=(t,n,l=e)=>{if(!t.length)return!1;n.push({value:l.value,selectionStart:l.selectionStart,selectionEnd:l.selectionEnd,timestamp:Date.now()});let s=t.pop();return l.value=s.value,l.setSelectionRange(s.selectionStart,s.selectionEnd),o(),!0},c=()=>{let e=[],t=0,n=Date.now()-3e4;l.toReversed().forEach((l=>{if(l.timestamp>=n)return void e.unshift(l);let s=(e=>{let t=(Date.now()-e)/1e3;return[1,5,10,30][[30,120,300,900].findIndex((e=>t<e))]??60})(l.timestamp);l.timestamp-t>=1e3*s&&(e.unshift(l),t=l.timestamp)})),l.length=0,l.push(...e)};let u="  ";function d(t,n=e){const l=n.selectionStart,s=n.selectionEnd,a=n.value;let o=a.lastIndexOf("\n",l-1)+1,i=a.indexOf("\n",s);-1===i&&(i=a.length);const r=a.substring(o,i),c=s-l;let u,d;if("up"===t)n.setRangeText(r+"\n",o,o),u=o+(l-o);else{if("down"!==t)return;n.setRangeText("\n"+r,i,i),u=i+1+(l-o)}d=u+c,n.setSelectionRange(u,d),n.focus()}const h=t=>{let n=e.value.split("\n"),{selectionStart:l,selectionEnd:s}=e,a=e.value.substring(0,l).split("\n").length-1,o=e.value.substring(0,s).split("\n").length-1,i="up"===t,r=i?a-1:o+1;if(r<0||r>=n.length)return;let c=[0];for(let e=0;e<n.length-1;e++)c.push(c[e]+n[e].length+1);let u=l-c[a],d=s-c[o],h=n.slice(a,o+1),g=n[r];let p=a+(i?-1:1),f=o+(i?-1:1);i?n.splice(a-1,h.length+1,...h,g):n.splice(a,h.length+1,g,...h),e.value=n.join("\n");let m=(e=>{let t=[0];for(let n=0;n<e.length-1;n++)t.push(t[n]+e[n].length+1);return t})(n),v=m[p]+u,F=m[f]+d;e.setSelectionRange(v,F)};function g(t,n=e){let l=u,{selectionStart:s,selectionEnd:a,value:o}=n,i=o.lastIndexOf("\n",s-1)+1,r=o.indexOf("\n",a);-1===r&&(r=o.length);let c=o.slice(i,r).split(/(\r?\n)/),d=c.some((e=>e.startsWith("\t")||e.startsWith(" ")));if(!t&&!d)return;let h=c.map((e=>t?l+e:e.startsWith("\t")?e.slice(1):e.startsWith("  ")?e.slice(2):e.startsWith(" ")?e.slice(1):e)),g=h.join(""),p=h.reduce(((e,t,n)=>e+(t.length-c[n].length)),0),f=t?l.length:o.slice(i,s).startsWith(l)?-l.length:0;n.setRangeText(g,i,r,"preserve"),n.setSelectionRange(s+f,a+p)}let p=()=>r(l,s),f=()=>r(s,l);const m=e=>e.sort().join("+"),v=[[["alt","shift","arrowup"],()=>d("up")],[["alt","shift","arrowdown"],()=>d("down")],[["alt","arrowup"],()=>h("up")],[["alt","arrowdown"],()=>h("down")],[["meta","["],()=>g(!1)],[["meta","]"],()=>g(!0)],[["tab"],()=>((t,n=e)=>{let l=n.selectionStart;n.setRangeText(t,l,n.selectionEnd,"end");let s=l+t.length;n.setSelectionRange(s,s)})(u)],[["shift","tab"],(t=e)=>{let{selectionStart:n,selectionEnd:l,value:s}=t,a=s.slice(0,n),o=s.slice(l);if(a.endsWith(u))a=a.slice(0,-u.length),n-=u.length;else if(/\n[ \t]*$/.test(a)){let e=a.match(/\n[ \t]*$/);a=a.slice(0,e.index+1),n-=e[0].length-1}t.setRangeText(a+o,0,s.length,"preserve"),t.setSelectionRange(n,n)}],[["control","z"],p],[["meta","z"],p],[["meta","shift","z"],f],[["control","y"],f]].reduce(((e,[t,n])=>(e[m(t)]=n,e)),{});let F=new Set(["Control","Meta","Shift","Alt","AltGraph","Tab","Escape","Enter","Backspace","Delete","CapsLock","NumLock","ScrollLock","Fn","FnLock","Symbol","SymbolLock","ContextMenu","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","PageUp","PageDown","PrintScreen","Pause","Insert","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","Convert","NonConvert","KanaMode","Lang1","Lang2"]);return e.addEventListener("keydown",(e=>{let t=function(e){let t=new Set;return t.add(e.key.toLowerCase()),e.metaKey&&t.add("meta"),e.ctrlKey&&t.add("control"),e.shiftKey&&t.add("shift"),e.altKey&&t.add("alt"),m([...t])}(e),n=v[t]||null;n?(e.preventDefault(),n!==p&&n!==f&&i(),n()):"enter"===e.key||"backspace"===e.key||"delete"===e.key||(e.metaKey||e.ctrlKey)&&("v"===e.key||"x"===e.key)?i():e.ctrlKey||e.metaKey||e.altKey||F.has(e.key)||Date.now()-a>2e3&&i()})),{set_value:t=>{i(),e.value=t},undo_stack:l,redo_stack:s,undo:p,redo:f}}